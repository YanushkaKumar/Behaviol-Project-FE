name: Frontend CI/CD (VM + GKE)

on:
  push:
    branches:
      - master        # → Deploy static build to VM (NGINX)
      - gke-release   # → Build container & deploy to GKE

permissions:
  contents: read

concurrency:
  group: frontend-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  APP_NAME: todo-frontend

# ==================== JOB: DEPLOY TO VM (master) ====================
jobs:
  deploy-to-vm:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Create .env.production
        run: |
          echo "REACT_APP_API_URL=${{ secrets.FRONTEND_API_URL }}" > .env.production
          echo ".env.production created"

      - name: Install deps
        run: npm ci

      - name: Build (skip CI lint)
        run: CI=false npm run build

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: compute

      - name: Copy build to VM
        run: |
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} --zone=${{ secrets.GCP_VM_ZONE }} --command="mkdir -p ~/frontend-temp"
          gcloud compute scp --recurse build/* \
            ${{ secrets.GCP_VM_NAME }}:~/frontend-temp/ \
            --zone=${{ secrets.GCP_VM_ZONE }}

      - name: Move to NGINX dir & restart
        run: |
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} \
            --zone=${{ secrets.GCP_VM_ZONE }} \
            --command="sudo mkdir -p /opt/frontend/Behaviol-Project-FE/build && \
                       sudo rm -rf /opt/frontend/Behaviol-Project-FE/build/* && \
                       sudo mv ~/frontend-temp/* /opt/frontend/Behaviol-Project-FE/build/ && \
                       rm -rf ~/frontend-temp && \
                       sudo systemctl restart nginx"

# ==================== JOB: DEPLOY TO GKE (gke-release) ====================
  deploy-to-gke:
    if: github.ref == 'refs/heads/gke-relse'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Create .env.production
        run: |
          echo "REACT_APP_API_URL=${{ secrets.FRONTEND_API_URL }}" > .env.production
          echo ".env.production created"

      - name: Install deps
        run: npm ci

      - name: Build (skip CI lint)
        run: CI=false npm run build

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build & Tag Docker image
        run: |
          IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO_NAME }}/${{ env.APP_NAME }}"
          docker build -t "${IMAGE}:${{ github.sha }}" .
          docker tag "${IMAGE}:${{ github.sha }}" "${IMAGE}:latest"

      - name: Push Docker image
        run: |
          IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO_NAME }}/${{ env.APP_NAME }}"
          docker push "${IMAGE}:${{ github.sha }}"
          docker push "${IMAGE}:latest"

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install GKE auth plugin
        run: gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} \
            --zone=${{ secrets.GKE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Update Deployment image
        run: |
          IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO_NAME }}/${{ env.APP_NAME }}"
          kubectl set image deployment/todo-frontend \
            todo-frontend="${IMAGE}:${{ github.sha }}" \
            -n todo-backend

      - name: Wait for rollout
        run: kubectl rollout status deployment/todo-frontend -n todo-backend

      - name: Post-deploy checks
        run: |
          echo "=== Pods ==="
          kubectl get pods -n todo-backend -l app=todo-frontend
          echo "=== Service ==="
          kubectl get svc todo-frontend-service -n todo-backend
          echo "=== Deployment describe ==="
          kubectl describe deployment todo-frontend -n todo-backend

      - name: Show frontend LB IP (if Service is LoadBalancer)
        run: |
          kubectl get service todo-frontend-service -n todo-backend -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || true
